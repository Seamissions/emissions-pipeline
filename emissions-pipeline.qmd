---
title: "Emissions Pipeline"
date: last-modified
format:
  html:
      toc: true
      code-fold: true
editor: visual
execute:
  warning: false
  messages: false
editor_options: 
  chunk_output_type: console
---

# About

This repository hosts the code to create the open source data processing pipeline.

## Load packages
```{r}
#| code-summary: Expand code
library(tidyverse)
library(janitor)
library(here)
library(gghighlight)
library(lubridate)
```

## Load data
```{r}
#| code-summary: Expand code

# Turn off scientific notation
options(scipen=999)

# Set file path to data folder
pathway <- "/capstone/seamissions/data/meds_capstone_project"

# Set up import for .csv or .xlsx files
file_names <- list.files(here(pathway), pattern=paste0(c("*.xlsx","*.csv"), collapse="|"), full.names=TRUE)

# Read in data files
for (i in seq_along(file_names)) {
  # If .csv, read_csv
  if(grepl('.*\\.csv', file_names[i])) {
        table <- read_csv(file_names[i], show_col_types = FALSE) %>%
          clean_names()
         } else {
           # If .xslx, read_excel
           table <- read_excel(file_names[i]) %>%
             clean_names()
         }
  
  # Rename files truncated names
  if(str_detect(file_names[i], "non")) {
    table_name <- substr(file_names[i], 64, 79)
  } else {
    table_name <- substr(file_names[i], 64, 76)
  }
  assign(table_name, table)
}
```

## Clean data
```{r}
#| code-summary: Expand code
# Create `year_month` column
broadcasting <- ais_emissions %>%
  mutate(date = lubridate::ymd(time)) %>%
  mutate(year_month = format(date, '%Y-%m'))
  
# Create `year_month` column
non_broadcasting <- non_broadcasting %>%
  mutate(date = lubridate::ymd(time)) %>%
  mutate(year_month = format(date, '%Y-%m'))
```

```{r}
#| code-summary: Expand code
# Merge broadcasting and non-broadcasting datasets
emissions <- left_join(broadcasting, non_broadcasting, by = c("year_month", "lat_bin", "lon_bin", "length_size_class_percentile")) %>%
  
  # Create lat_long bin to group by pixel
  mutate(lat_long = paste0(lat_bin, "_", lon_bin)) %>%
  
  # Select columns to keep
  select(year_month, 
         lat_long, 
         flag, 
         vessel_class, 
         length_size_class_percentile, 
         fishing, 
         hours, 
         emissions_co2_mt, 
         emissions_ch4_mt, 
         emissions_n2o_mt, 
         emissions_nox_mt, 
         emissions_sox_mt, 
         emissions_pm_mt, 
         emissions_co_mt,
         emissions_co2_non_broadcasting_mt,
         emissions_ch4_non_broadcasting_mt,
         emissions_n2o_non_broadcasting_mt,
         emissions_nox_non_broadcasting_mt,
         emissions_sox_non_broadcasting_mt,
         emissions_pm_non_broadcasting_mt,
         emissions_co_non_broadcasting_mt)

# Subset data for test
emissions_2017 <- emissions %>%
  filter(year_month == "2017-11")

# Partition emissions for test data 
key <- emissions_2017 %>%
  group_by(year_month, lat_long, flag) %>%
  mutate(total_hours_by_flag = sum(hours)) %>%
  group_by(year_month, lat_long) %>%
  mutate(total_hours = sum(hours)) %>%
  ungroup() %>%
  mutate(factor = total_hours_by_flag/total_hours) %>%
  mutate(total_co2 = emissions_co2_mt + (factor * emissions_co2_non_broadcasting_mt),
         total_ch4 = emissions_ch4_mt + (factor * emissions_ch4_non_broadcasting_mt),
         total_n2o = emissions_n2o_mt + (factor * emissions_n2o_non_broadcasting_mt),
         total_nox = emissions_nox_mt + (factor * emissions_nox_non_broadcasting_mt),
         total_sox = emissions_sox_mt + (factor * emissions_sox_non_broadcasting_mt),
         total_pm = emissions_pm_mt + (factor * emissions_pm_non_broadcasting_mt),
         total_co = emissions_co_mt + (factor * emissions_co_non_broadcasting_mt)) %>%
   select(year_month, 
         lat_long, 
         flag, 
         vessel_class, 
         length_size_class_percentile, 
         fishing, 
         total_co2, 
         total_ch4, 
         total_n2o, 
         total_nox, 
         total_sox, 
         total_pm, 
         total_co)

# Adapt this code to full dataset
```

## Decision points:

- If only dark fleet in a pixel, how do we distribute emissions? Next closest month or next closest pixel? - add +/-1 to lat_long?

## Visualize (maps, time series plots)

