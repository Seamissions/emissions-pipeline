---
title: "Emissions Pipeline"
date: last-modified
format:
  html:
      toc: true
      code-fold: true
editor: visual
execute:
  warning: false
  messages: false
editor_options: 
  chunk_output_type: console
---

# About

This repository hosts the code to create the open source data processing pipeline. 

## Load packages
```{r}
#| code-summary: Expand code
library(tidyverse)
library(janitor)
library(here)
library(gghighlight)
```

## Load data
```{r}
#| code-summary: Expand code
# Set file path to data folder
pathway <- "/capstone/seamissions/data/meds_capstone_project"

# Set up import for .csv or .xlsx files
file_names <- list.files(here(pathway), pattern=paste0(c("*.xlsx","*.csv"), collapse="|"), full.names=TRUE)

# Read in data files
for (i in seq_along(file_names)) {
  if(grepl('.*\\.csv', file_names[i])) {
        table <- read_csv(file_names[i], show_col_types = FALSE)
         } else {
           table <- read_excel(file_names[i])
         }
  
  table <- table %>%
  clean_names()
  
  if(str_detect(file_names[i], "non")) {
    table_name <- substr(file_names[i], 64, 79)
  } else {
    table_name <- substr(file_names[i], 64, 76)
  }
  assign(table_name, table)
}
```

## Clean data
- Filter for fishing == TRUE
  Some "passenger" say fishing == TRUE?
- Add "flag" column to non-broadcasting, "nb-fleet" to keep independent from flag "unknown"
```{r}
#| code-summary: Expand code
# Filter for fishing vessels
broadcasting <- ais_emissions %>%
  filter(fishing == TRUE)

# Add flag to non-broadcasting fleet
non_broadcasting <- non_broadcasting %>%
  mutate(flag = "nb-fleet")
```

## Join data
- Left join could eliminate non-broadcasting vessels that don't overlap with known pixels, would add to existing rows and we wanted new rows.
- Used bind_rows instead.
- We need to standardize column names first.
```{r}
#| code-summary: Expand code
# Rename columns in non_broadcasting to match broadcasting
non_broadcasting <- non_broadcasting %>%
  rename(emissions_co2_mt = emissions_co2_non_broadcasting_mt,
         emissions_ch4_mt = emissions_ch4_non_broadcasting_mt,
         emissions_n2o_mt = emissions_n2o_non_broadcasting_mt,
         emissions_nox_mt = emissions_nox_non_broadcasting_mt,
         emissions_sox_mt = emissions_sox_non_broadcasting_mt,
         emissions_pm_mt = emissions_pm_non_broadcasting_mt, 
         emissions_co_mt = emissions_co_non_broadcasting_mt)

# Combine datasets
emissions <- bind_rows(broadcasting, non_broadcasting) %>%
  # Remove unwanted columns
  select(!c("fishing", "hours")) %>%
  # Create lat_long column
  mutate(lat_long = paste0(lat_bin, "_", lon_bin)) %>%
  # Create year_month column
  mutate(date = lubridate::ymd(time)) %>%
  mutate(year_month = format(date, '%Y-%m'))

# Group dataset by pixel
emissions_by_pixel <- emissions %>%
  group_by(lat_long, year_month, flag, vessel_class) %>% 
  summarize(number_vessels = n(),
            co2 = sum(emissions_co2_mt))

# Look at one pixel as an example
pixel_example <- emissions_by_pixel %>%
  filter(lat_long == "-10_-140") 
```

## Decision points:
For a given month, distribute dark fleet data by proximity to known flags (within pixel).
- If only dark fleet in a pixel, how do we distribute emissions? Next closest month or next closest pixel?
- add +/-1 to lat_long?


Visualize (maps, time series plots)












