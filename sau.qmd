---
title: "Sea Around Us"
author: "Carmen Hoyt"
date: last-modified
format:
  html:
      toc: true
      code-fold: true
editor: visual
execute:
  warning: false
  messages: false
editor_options: 
  chunk_output_type: console
---

Load Packages

```{r}
#| code-summary: Expand code
library(tidyverse)
library(janitor)
library(here)

# Turn off scientific notation
options(scipen=999)
```

Import Data

```{r}
#| code-summary: Expand code
# add iso flag code
iso_flags <- read_csv("/capstone/seamissions/data/fao_seafood_production/CL_FI_COUNTRY_GROUPS.csv", show_col_types = FALSE) %>%
  clean_names() %>%
  select(iso3_code, name_en) %>%
  # change and to & to match the SAU data
  mutate(name_en = str_replace_all(name_en, " and ", " & "))

# Set up import for .csv files
file_names <- list.files("/capstone/seamissions/data/sau", pattern="*.csv", full.names = TRUE)

sau_regions <- vector("list", length = length(file_names))

# Read in emissions data files
for (i in seq_along(file_names)) {
  table_name <- paste0("sau_region_", str_sub(file_names[i], 40, 41))
  sau_regions[[i]] <- assign(table_name, read.csv(file_names[i], stringsAsFactors = FALSE, check.names = TRUE) %>%
                               clean_names() %>%
                               mutate(zone = as.numeric(str_sub(file_names[i], 40, 41)),
                                      year = as.numeric(year)) %>%
                               filter(year >= 2015) %>%
                               left_join(iso_flags, by = c("fishing_entity" = "name_en")) %>%
                               mutate(flag = ifelse(is.na(iso3_code), fishing_entity, iso3_code))
                               )
}

sau_catch_data <- bind_rows(sau_regions)

sau_catch_summary <- sau_catch_data %>%
  group_by(zone, year, flag, scientific_name) %>%
  summarise(sau_catch_tons = sum(tonnes, na.rm = TRUE))

emissions_sau_joined <- left_join(emissions_partitioned_grouped, sau_catch_summary, by = c("zone", "year", "flag"))

# warning for missing catch
catch_before <- sum(sau_catch_summary$sau_catch_tons, na.rm = TRUE)
catch_after <- sum(emissions_sau_joined$sau_catch_tons, na.rm = TRUE)
change_catch <- (catch_before - catch_after)/catch_before

if(change_catch > 0) {
  warning(paste0(change_catch*100, "% of catch (in tons) lost in full dataset during join."))
}

# SAU catch loss by region
regions <- c(18, 21, 27, 31, 34, 47, 48, 51, 57, 58, 61, 67, 71, 77, 81, 87, 88)

for(x in regions) {
  # Filter for zone
  sau_region <- sau_catch_summary %>%
    filter(zone == x)
  joined_region <- emissions_sau_joined %>%
    filter(zone == x)
  
  # Calculate loss
  catch_before <- sum(sau_region$sau_catch_tons, na.rm = TRUE)
  catch_after <- sum(joined_region$sau_catch_tons, na.rm = TRUE)
  change_catch <- (catch_before - catch_after)/catch_before
  
  print(paste0("Zone ", x, " lost ~", round(change_catch*100, 0), "% of catch (in tons)."))
  
}
```
