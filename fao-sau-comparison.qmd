---
title: "FAO SAU Comparison"
format: html
editor: visual
---

## Load Packages

```{r}
#| code-summary: Load Packages
library(tidyverse)
library(janitor)
library(here)
library(lubridate)
library(sf)
```

## Load Data

```{r}
full_emissions_fao <- read_csv(file.path("/capstone/seamissions/checkpoint/full_emissions_fao.csv"), show_col_types = FALSE)
full_emissions_sau <- read_csv(file.path("/capstone/seamissions/checkpoint/full_emissions_sau.csv"), show_col_types = FALSE)
```

## Clean Data

```{r}
# # Columns to rename
# cols_to_rename <- c(colnames(full_emissions_fao)[str_detect(colnames(full_emissions_fao), "_mt")])
# 
# # Add "fao_" prefix to FAO data
# colnames(full_emissions_fao)[colnames(full_emissions_fao) %in% cols_to_rename] <- paste0("fao_", colnames(full_emissions_fao)[colnames(full_emissions_fao) %in% cols_to_rename])
# 
# # Add "sau_" prefix to SAU data
# colnames(full_emissions_sau)[colnames(full_emissions_sau) %in% cols_to_rename] <- paste0("sau_", colnames(full_emissions_sau)[colnames(full_emissions_sau) %in% cols_to_rename])
```

## Compare Each Pollutant

```{r}
# List pollutants
pollutants <- c("co2", 
                "ch4",
                "n2o",
                "nox",
                "sox",
                "co",
                "vocs",
                "pm2_5",
                "pm10")

# Regional comparison by flag and year
fao_summary <- full_emissions_fao %>%
  group_by(zone, year, flag) %>%
  summarise(fao_total_co2_mt = sum(total_co2_mt, na.rm = TRUE))

sau_summary <- full_emissions_sau %>%
  group_by(zone, year, flag) %>%
  summarise(sau_total_co2_mt = sum(total_co2_mt, na.rm = TRUE))

region_year_flag_comparison_table <- full_join(fao_summary, sau_summary, by = c("zone", "year", "flag")) %>%
  mutate(percent_reported_co2 =round((fao_total_co2_mt/sau_total_co2_mt)*100, 2),
         tonnage_discrepancy_co2 = round(fao_total_co2_mt - sau_total_co2_mt, 2))  %>%
  group_by(zone, year) %>%
  arrange(tonnage_discrepancy_co2, .by_group = TRUE)

#write_csv(region_year_flag_comparison_table, file.path("/capstone/seamissions/checkpoint/region_year_flag_comparison_table.csv"))

# Global comparison by flag
fao_summary <- full_emissions_fao %>%
  group_by(flag) %>%
  summarise(fao_total_co2_mt = sum(total_co2_mt, na.rm = TRUE))

sau_summary <- full_emissions_sau %>%
  group_by(flag) %>%
  summarise(sau_total_co2_mt = sum(total_co2_mt, na.rm = TRUE))

global_flag_comparison_table <- full_join(fao_summary, sau_summary, by = "flag") %>%
  mutate(percent_reported_co2 = round((fao_total_co2_mt/sau_total_co2_mt)*100, 2),
         tonnage_discrepancy_co2 = round(fao_total_co2_mt - sau_total_co2_mt, 2)) %>%
  arrange(desc(tonnage_discrepancy_co2), .by_group = TRUE)
  # full_join(to_country_emissions, by = "flag") %>%
  # select(-c(match, vessels, emissions, total_emissions)) %>%
  # full_join(from_country_emissions, by = "flag") %>%
  # select(-c(match, vessels, emissions, total_emissions)) 

#write_csv(global_flag_comparison_table, file.path("/capstone/seamissions/checkpoint/global_flag_comparison_table.csv"))

# Regional comparison by flag
fao_summary <- full_emissions_fao %>%
  group_by(zone, flag) %>%
  summarise(fao_total_co2_mt = sum(total_co2_mt, na.rm = TRUE))

sau_summary <- full_emissions_sau %>%
  group_by(zone, flag) %>%
  summarise(sau_total_co2_mt = sum(total_co2_mt, na.rm = TRUE))

zone_flag_comparison_table <- full_join(fao_summary, sau_summary, by = c("zone", "flag")) %>%
  mutate(percent_reported_co2 = round((fao_total_co2_mt/sau_total_co2_mt)*100, 2),
         tonnage_discrepancy_co2 = round(fao_total_co2_mt - sau_total_co2_mt, 2)) %>%
  group_by(zone) %>%
  arrange(tonnage_discrepancy_co2, .by_group = TRUE)

#write_csv(zone_flag_comparison_table, file.path("/capstone/seamissions/checkpoint/zone_flag_comparison_table.csv"))


# global catch by flag
fao_summary <- full_emissions_fao %>%
  group_by(flag) %>%
  summarise(fao_catch_tons = sum(country_total_tons_by_species, na.rm = TRUE))

sau_summary <- full_emissions_sau %>%
  group_by(flag) %>%
  summarise(sau_catch_tons = sum(country_total_tons_by_species, na.rm = TRUE))
```

# Make Species Key

[The current International Standard Statistical Classification of Aquatic Animals and Plants (ISSCAAP) in use from 2000](https://www.fao.org/fishery/docs/DOCUMENT/cwp/handbook/annex/AnnexS2listISSCAAP2000.pdf)

[Species Codes](https://www.fao.org/fishery/static/ASFIS/ASFIS_References_2024_EN.pdf)

The seven functional groups are: 1. Pisces, 2. Mollusca, 3. Crustacea, 4. Mammalia, 5. Amphibia-ReptileAves, 6. Invertabrata aquatica, 7. Plantae aquaticae

```{r}
check <- left_join(full_emissions_fao, fao_species, by = "identifier")
```

# Including flag analysis information:

```{r}
global_flag_comparison_table_2 <- global_flag_comparison_table %>%
  left_join(to_country_emissions, by = "flag") %>%
  select(-c(match, vessels, emissions, total_emissions))
```


By species?


```{r}
for(i in pollutants) {
  fao_pollutant_col <- colnames(full_emissions_fao)[str_detect(colnames(full_emissions_fao), pollutants[1])]
  sau_pollutant_col <- colnames(full_emissions_sau)[str_detect(colnames(full_emissions_sau), pollutants[1])]
  
  fao_table <- full_emissions_fao %>%
    select(year, zone, flag, species, all_of(fao_pollutant_col)) %>%
    mutate(species = ifelse(is.na(species), "broadcasting, no catch", species))
    #rename(fao_species = species)
  
  sau_table <- full_emissions_sau %>%
    select(year, zone, flag, species, all_of(sau_pollutant_col)) %>%
    mutate(species = ifelse(is.na(species), "broadcasting, no catch", species))
    #rename(sau_species = species)
  
  comparison_table <- full_join(fao_table, sau_table, by = c("zone", "year", "flag", "species"))
  
}
```

